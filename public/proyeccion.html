<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Momentos en Vivo - Proyección</title>
    <style>
        body { margin: 0; background-color: #000; color: white; overflow: hidden; font-family: sans-serif; }
        #projection-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #projection-container img { max-width: 95%; max-height: 95%; position: absolute; opacity: 0; transform: scale(1.05); transition: opacity 1.5s ease-in-out, transform 1.5s ease-in-out; }
        #projection-container img.visible { opacity: 1; transform: scale(1); }
        #placeholder { font-size: 2em; color: #555; }
        #qr-container { position: absolute; bottom: 20px; right: 20px; background-color: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column; align-items: center; z-index: 100; }
        #qr-container img { width: 150px; height: 150px; border: 2px solid #333; }
        #qr-container p { margin: 5px 0 0; font-size: 0.8em; color: #333; text-align: center; }
    </style>
</head>
<body>
    <div id="projection-container">
        <div id="placeholder">Esperando fotos aprobadas...</div>
        <div id="qr-container">
            <img id="qr-code-img" alt="Código QR para subir fotos">
            <p>¡Escanea para enviar tu foto!</p>
        </div>
    </div>

    <script>
        const container = document.getElementById('projection-container');
        const placeholder = document.getElementById('placeholder');
        const qrCodeImg = document.getElementById('qr-code-img');
        const NETLIFY_URL = 'https://playful-parfait-6bfab1.netlify.app';

        // Genera el QR usando la URL de Netlify
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(NETLIFY_URL)}`;
        qrCodeImg.src = qrApiUrl;

        let currentIndex = -1;
        let photos = [];
        let knownPhotoIds = new Set();
        let slideshowInterval;

        function displayPhoto(photo) {
            if (!photo) return;
            const currentImage = container.querySelector('img.visible');
            if (currentImage) {
                currentImage.classList.remove('visible');
            }
            const allImages = container.querySelectorAll('img');
            if (allImages.length > 10) {
                allImages[0].remove();
            }
            const nextImage = document.createElement('img');
            nextImage.id = photo.asset_id;
            nextImage.src = photo.secure_url;
            container.appendChild(nextImage);
            setTimeout(() => {
                nextImage.classList.add('visible');
            }, 500);
        }
        
        function showNextPhotoInLoop() {
            if (photos.length === 0) return;
            currentIndex = (currentIndex + 1) % photos.length;
            displayPhoto(photos[currentIndex]);
        }

        async function fetchApprovedPhotos() {
            try {
                const response = await fetch(`${NETLIFY_URL}/.netlify/functions/get-approved-photos`);
                if (!response.ok) return;
                const newPhotos = await response.json();
                const newPhoto = newPhotos.find(p => !knownPhotoIds.has(p.asset_id));
                photos = newPhotos;
                photos.forEach(p => knownPhotoIds.add(p.asset_id));
                placeholder.style.display = photos.length > 0 ? 'none' : 'block';
                if (newPhoto) {
                    console.log("¡Nueva foto detectada! Mostrando ahora:", newPhoto.public_id);
                    displayPhoto(newPhoto);
                    clearInterval(slideshowInterval);
                    slideshowInterval = setInterval(showNextPhotoInLoop, 7000);
                }
            } catch (error) {
                console.error("Error cargando fotos:", error);
            }
        }

        async function start() {
            await fetchApprovedPhotos();
            if (photos.length > 0) {
                showNextPhotoInLoop();
            }
            slideshowInterval = setInterval(showNextPhotoInLoop, 7000);
            setInterval(fetchApprovedPhotos, 10000);
        }

        start();
    </script>
</body>
</html>